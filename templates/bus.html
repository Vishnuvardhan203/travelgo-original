<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelGo - Bus Booking</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a" cx="50%" cy="0%"><stop offset="0%" stop-color="rgba(255,255,255,0.1)"/><stop offset="100%" stop-color="rgba(255,255,255,0)"/></radialGradient></defs><rect width="100" height="20" fill="url(%23a)"/></svg>') repeat-x;
            pointer-events: none;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .nav-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 2;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .search-section {
            padding: 40px;
            background: linear-gradient(45deg, #f8fafc, #e2e8f0);
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            transform: translateY(-2px);
        }

        .search-btn {
            grid-column: 1 / -1;
            padding: 18px 40px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .search-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .results-count {
            font-size: 1.2em;
            color: #374151;
            font-weight: 600;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #e5e7eb;
        }

        .bus-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .bus-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .bus-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .bus-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #1f2937;
        }

        .bus-type {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .bus-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-item {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 10px;
        }

        .detail-label {
            font-size: 0.8em;
            color: #6b7280;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
        }

        .bus-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .price {
            font-size: 1.5em;
            font-weight: 700;
            color: #059669;
        }

        .select-seat-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .select-seat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .seat-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .seat-selection-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #ef4444;
        }

        .bus-layout {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .seat-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-seat {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-seat.available {
            background: #10b981;
        }

        .legend-seat.occupied {
            background: #ef4444;
        }

        .legend-seat.selected {
            background: #f59e0b;
        }

        .seats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 0 auto;
        }

        .seat {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .seat.available {
            background: #10b981;
            color: white;
        }

        .seat.available:hover {
            background: #059669;
            transform: scale(1.1);
        }

        .seat.occupied {
            background: #ef4444;
            color: white;
            cursor: not-allowed;
        }

        .seat.selected {
            background: #f59e0b;
            color: white;
            transform: scale(1.1);
        }

        .seat-info {
            margin: 20px 0;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 10px;
            border-left: 4px solid #0ea5e9;
        }

        .booking-summary {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-total {
            font-size: 1.2em;
            font-weight: 700;
            color: #059669;
            border-top: 2px solid #e5e7eb;
            padding-top: 10px;
            margin-top: 10px;
        }

        .book-now-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .book-now-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3);
        }

        .book-now-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav-buttons {
                position: static;
                justify-content: center;
                margin-top: 20px;
            }

            .search-section {
                padding: 20px;
            }

            .search-form {
                grid-template-columns: 1fr;
            }

            .bus-details {
                grid-template-columns: repeat(2, 1fr);
            }

            .bus-footer {
                flex-direction: column;
                gap: 15px;
            }

            .seats-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                max-width: 250px;
            }

            .seat {
                width: 35px;
                height: 35px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <div class="nav-buttons">
                <a href="{{ url_for('dashboard') }}" class="nav-btn">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                
            </div>
            <h1><i class="fas fa-bus"></i> Bus Booking</h1>
            <p>Find and book your perfect bus journey</p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <form class="search-form" id="busSearchForm">
                <div class="form-group">
                    <label for="from">From</label>
                    <input type="text" id="from" name="from" placeholder="Departure city" required>
                </div>
                
                <div class="form-group">
                    <label for="to">To</label>
                    <input type="text" id="to" name="to" placeholder="Destination city" required>
                </div>
                
                <div class="form-group">
                    <label for="date">Departure Date</label>
                    <input type="date" id="date" name="date" required>
                </div>
                
                <div class="form-group">
                    <label for="busType">Bus Type</label>
                    <select id="busType" name="busType">
                        <option value="">All Types</option>
                        <option value="ac">AC</option>
                        <option value="non-ac">Non-AC</option>
                        <option value="sleeper">Sleeper</option>
                        <option value="semi-sleeper">Semi-Sleeper</option>
                    </select>
                </div>
                
                <button type="submit" class="search-btn">
                    <i class="fas fa-search"></i> Search Buses
                </button>
            </form>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="results-count" id="resultsCount">Found 0 buses</div>
                <button class="filter-btn" onclick="toggleFilters()">
                    <i class="fas fa-filter"></i> Filters
                </button>
            </div>
            
            <div id="busResults">
                <!-- Bus results will be populated here -->
            </div>
        </div>
    </div>

    <!-- Seat Selection Modal -->
    <div class="seat-selection-modal" id="seatModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Select Your Seats</h2>
                <button class="close-btn" onclick="closeSeatModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="bus-layout">
                <div class="seat-legend">
                    <div class="legend-item">
                        <div class="legend-seat available"></div>
                        <span>Available</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-seat occupied"></div>
                        <span>Occupied</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-seat selected"></div>
                        <span>Selected</span>
                    </div>
                </div>
                
                <div class="seats-grid" id="seatsGrid">
                    <!-- Seats will be generated here -->
                </div>
            </div>
            
            <div class="seat-info" id="seatInfo">
                <strong>Selected Seats:</strong> <span id="selectedSeats">None</span>
            </div>
            
            <div class="booking-summary" id="bookingSummary" style="display: none;">
                <div class="summary-item">
                    <span>Selected Seats:</span>
                    <span id="summarySeats"></span>
                </div>
                <div class="summary-item">
                    <span>Price per Seat:</span>
                    <span id="seatPrice">₹0</span>
                </div>
                <div class="summary-item summary-total">
                    <span>Total Amount:</span>
                    <span id="totalAmount">₹0</span>
                </div>
            </div>
            
            <button class="book-now-btn" id="bookNowBtn" onclick="proceedToBooking()" disabled>
                <i class="fas fa-credit-card"></i> Proceed to Booking
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let selectedSeats = [];
        let currentBusData = null;

        // Set minimum date to today
        document.getElementById('date').min = new Date().toISOString().split('T')[0];

        // Sample bus data (in real app, this would come from backend)
        const sampleBuses = [
            {
                id: 1,
                name: "Royal Express",
                type: "AC Sleeper",
                from: "Hyderabad",
                to: "Bangalore",
                departure: "22:30",
                arrival: "06:30",
                duration: "8h 0m",
                price: 850,
                rating: 4.5,
                amenities: ["AC", "Wi-Fi", "Charging Point", "Water Bottle"]
            },
            {
                id: 2,
                name: "City Connect",
                type: "Non-AC Semi-Sleeper",
                from: "Hyderabad",
                to: "Bangalore",
                departure: "23:00",
                arrival: "07:00",
                duration: "8h 0m",
                price: 650,
                rating: 4.2,
                amenities: ["Charging Point", "Water Bottle"]
            },
            {
                id: 3,
                name: "Metro Travels",
                type: "AC Seater",
                from: "Hyderabad",
                to: "Bangalore",
                departure: "06:00",
                arrival: "14:00",
                duration: "8h 0m",
                price: 750,
                rating: 4.3,
                amenities: ["AC", "Wi-Fi", "Charging Point"]
            }
        ];

        // Handle form submission
        document.getElementById('busSearchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            searchBuses();
        });

        function searchBuses() {
            const form = document.getElementById('busSearchForm');
            const formData = new FormData(form);
            
            // Show loading
            showLoading();
            
            // Simulate API call
            setTimeout(() => {
                displayBusResults(sampleBuses);
            }, 1500);
        }

        function showLoading() {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('active');
            resultsSection.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Searching for available buses...</p>
                </div>
            `;
        }

        function displayBusResults(buses) {
            const resultsSection = document.getElementById('resultsSection');
            
            resultsSection.innerHTML = `
                <div class="results-header">
                    <div class="results-count">Found ${buses.length} buses</div>
                    <button class="filter-btn" onclick="toggleFilters()">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                </div>
                <div id="busResults"></div>
            `;
            
            const busResultsContainer = document.getElementById('busResults');
            busResultsContainer.innerHTML = '';
            
            buses.forEach(bus => {
                const busCard = createBusCard(bus);
                busResultsContainer.appendChild(busCard);
            });
        }

        function createBusCard(bus) {
            const card = document.createElement('div');
            card.className = 'bus-card';
            card.innerHTML = `
                <div class="bus-header">
                    <div class="bus-name">${bus.name}</div>
                    <div class="bus-type">${bus.type}</div>
                </div>
                
                <div class="bus-details">
                    <div class="detail-item">
                        <div class="detail-label">Departure</div>
                        <div class="detail-value">${bus.departure}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Arrival</div>
                        <div class="detail-value">${bus.arrival}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Duration</div>
                        <div class="detail-value">${bus.duration}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Rating</div>
                        <div class="detail-value">
                            <i class="fas fa-star" style="color: #f59e0b;"></i> ${bus.rating}
                        </div>
                    </div>
                </div>
                
                <div class="bus-footer">
                    <div class="price">₹${bus.price}</div>
                    <button class="select-seat-btn" onclick="openSeatSelection(${bus.id})">
                        <i class="fas fa-chair"></i> Select Seats
                    </button>
                </div>
            `;
            return card;
        }

        function openSeatSelection(busId) {
            const bus = sampleBuses.find(b => b.id === busId);
            if (!bus) return;
            
            currentBusData = bus;
            selectedSeats = [];
            
            document.getElementById('modalTitle').textContent = `${bus.name} - Select Seats`;
            generateSeats();
            updateSeatInfo();
            
            document.getElementById('seatModal').classList.add('active');
        }

        function generateSeats() {
            const seatsGrid = document.getElementById('seatsGrid');
            seatsGrid.innerHTML = '';
            
            // Generate 40 seats (10 rows x 4 seats)
            const occupiedSeats = [3, 7, 12, 18, 25, 31, 37]; // Sample occupied seats
            
            for (let i = 1; i <= 40; i++) {
                const seat = document.createElement('button');
                seat.className = 'seat';
                seat.textContent = i;
                
                if (occupiedSeats.includes(i)) {
                    seat.classList.add('occupied');
                    seat.disabled = true;
                } else {
                    seat.classList.add('available');
                    seat.addEventListener('click', () => toggleSeat(i, seat));
                }
                
                seatsGrid.appendChild(seat);
            }
        }

        function toggleSeat(seatNumber, seatElement) {
            if (seatElement.classList.contains('selected')) {
                // Deselect seat
                seatElement.classList.remove('selected');
                seatElement.classList.add('available');
                selectedSeats = selectedSeats.filter(s => s !== seatNumber);
            } else {
                // Select seat (limit to 6 seats)
                if (selectedSeats.length < 6) {
                    seatElement.classList.remove('available');
                    seatElement.classList.add('selected');
                    selectedSeats.push(seatNumber);
                } else {
                    alert('You can select maximum 6 seats at a time.');
                    return;
                }
            }
            
            updateSeatInfo();
        }

        function updateSeatInfo() {
            const selectedSeatsSpan = document.getElementById('selectedSeats');
            const bookingSummary = document.getElementById('bookingSummary');
            const bookNowBtn = document.getElementById('bookNowBtn');
            
            if (selectedSeats.length === 0) {
                selectedSeatsSpan.textContent = 'None';
                bookingSummary.style.display = 'none';
                bookNowBtn.disabled = true;
            } else {
                selectedSeatsSpan.textContent = selectedSeats.join(', ');
                bookingSummary.style.display = 'block';
                bookNowBtn.disabled = false;
                
                // Update booking summary
                document.getElementById('summarySeats').textContent = selectedSeats.join(', ');
                document.getElementById('seatPrice').textContent = `₹${currentBusData.price}`;
                document.getElementById('totalAmount').textContent = `₹${currentBusData.price * selectedSeats.length}`;
            }
        }

        function closeSeatModal() {
            document.getElementById('seatModal').classList.remove('active');
            selectedSeats = [];
            currentBusData = null;
        }

        function proceedToBooking() {
    if (selectedSeats.length === 0) {
        alert('Please select at least one seat.');
        return;
    }

    const bookingData = {
        from: document.getElementById('from').value,
        to: document.getElementById('to').value,
        date: document.getElementById('date').value,
        seat: selectedSeats.join(', '),
        price: `${currentBusData.price * selectedSeats.length}`,
        busName: currentBusData.name,
        status: 'Confirmed'
    };

    const bookNowBtn = document.getElementById('bookNowBtn');
    bookNowBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    bookNowBtn.disabled = true;

    fetch('/api/book_bus', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    credentials: 'include', // ✅ this is CRITICAL
    body: JSON.stringify(bookingData)
})

    .then(res => res.json())
    .then(data => {
        console.log("Bus booking saved:", data);
        closeSeatModal();
        showBookingConfirmation(bookingData);
    })
    .catch(err => {
        console.error("Error booking bus:", err);
        alert("Booking failed. Please try again.");
    })
    .finally(() => {
        bookNowBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Booking';
        bookNowBtn.disabled = false;
    });
}


        function toggleFilters() {
            alert('Filter functionality will be implemented here. You can filter by price range, bus type, departure time, etc.');
        }

        // Close modal when clicking outside
        document.getElementById('seatModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSeatModal();
            }});

        // Additional features to continue the code:

        // Auto-complete for city names
        const popularCities = [
            'Hyderabad', 'Bangalore', 'Chennai', 'Mumbai', 'Delhi', 'Kolkata', 
            'Pune', 'Ahmedabad', 'Jaipur', 'Lucknow', 'Kanpur', 'Nagpur',
            'Indore', 'Thane', 'Bhopal', 'Visakhapatnam', 'Pimpri', 'Patna',
            'Vadodara', 'Ghaziabad', 'Ludhiana', 'Agra', 'Nashik', 'Faridabad'
        ];

        function setupAutoComplete() {
            const fromInput = document.getElementById('from');
            const toInput = document.getElementById('to');
            
            [fromInput, toInput].forEach(input => {
                input.addEventListener('input', function() {
                    const value = this.value.toLowerCase();
                    const suggestions = popularCities.filter(city => 
                        city.toLowerCase().includes(value)
                    );
                    showSuggestions(this, suggestions);
                });
            });
        }

        function showSuggestions(input, suggestions) {
            // Remove existing suggestions
            const existingSuggestions = input.parentNode.querySelector('.suggestions');
            if (existingSuggestions) {
                existingSuggestions.remove();
            }

            if (suggestions.length === 0 || input.value === '') return;

            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'suggestions';
            suggestionsDiv.style.cssText = `
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            `;

            suggestions.slice(0, 5).forEach(city => {
                const suggestionItem = document.createElement('div');
                suggestionItem.textContent = city;
                suggestionItem.style.cssText = `
                    padding: 10px 15px;
                    cursor: pointer;
                    border-bottom: 1px solid #f3f4f6;
                    transition: background-color 0.2s;
                `;
                suggestionItem.addEventListener('mouseenter', () => {
                    suggestionItem.style.backgroundColor = '#f8fafc';
                });
                suggestionItem.addEventListener('mouseleave', () => {
                    suggestionItem.style.backgroundColor = 'white';
                });
                suggestionItem.addEventListener('click', () => {
                    input.value = city;
                    suggestionsDiv.remove();
                });
                suggestionsDiv.appendChild(suggestionItem);
            });

            input.parentNode.style.position = 'relative';
            input.parentNode.appendChild(suggestionsDiv);
        }

        // Advanced filtering functionality
        function showFilterModal() {
            const filterModal = document.createElement('div');
            filterModal.id = 'filterModal';
            filterModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                backdrop-filter: blur(5px);
            `;

            filterModal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="font-size: 1.5em; font-weight: 700; color: #1f2937;">Filter Buses</h2>
                        <button onclick="closeFilterModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #6b7280;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Price Range</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="range" id="priceRange" min="300" max="1500" value="1500" style="flex: 1;">
                            <span id="priceValue">₹1500</span>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Departure Time</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" value="morning" name="timeSlot"> Morning (6AM-12PM)
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" value="afternoon" name="timeSlot"> Afternoon (12PM-6PM)
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" value="evening" name="timeSlot"> Evening (6PM-9PM)
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" value="night" name="timeSlot"> Night (9PM-6AM)
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Bus Types</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" value="ac" name="busTypeFilter"> AC
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" value="non-ac" name="busTypeFilter"> Non-AC
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" value="sleeper" name="busTypeFilter"> Sleeper
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" value="semi-sleeper" name="busTypeFilter"> Semi-Sleeper
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="clearFilters()" style="
                            flex: 1;
                            padding: 12px;
                            background: #f3f4f6;
                            border: 1px solid #d1d5db;
                            border-radius: 8px;
                            cursor: pointer;
                        ">Clear All</button>
                        <button onclick="applyFilters()" style="
                            flex: 1;
                            padding: 12px;
                            background: linear-gradient(135deg, #4f46e5, #7c3aed);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                        ">Apply Filters</button>
                    </div>
                </div>
            `;

            document.body.appendChild(filterModal);

            // Setup price range slider
            const priceRange = document.getElementById('priceRange');
            const priceValue = document.getElementById('priceValue');
            
            priceRange.addEventListener('input', function() {
                priceValue.textContent = `₹${this.value}`;
            });

            // Close modal on outside click
            filterModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFilterModal();
                }
            });
        }

        function closeFilterModal() {
            const filterModal = document.getElementById('filterModal');
            if (filterModal) {
                filterModal.remove();
            }
        }

        function clearFilters() {
            // Reset all filter inputs
            document.getElementById('priceRange').value = 1500;
            document.getElementById('priceValue').textContent = '₹1500';
            document.querySelectorAll('input[name="timeSlot"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="busTypeFilter"]').forEach(cb => cb.checked = false);
        }

        function applyFilters() {
            const maxPrice = parseInt(document.getElementById('priceRange').value);
            const selectedTimeSlots = Array.from(document.querySelectorAll('input[name="timeSlot"]:checked')).map(cb => cb.value);
            const selectedBusTypes = Array.from(document.querySelectorAll('input[name="busTypeFilter"]:checked')).map(cb => cb.value);
            
            // Filter the buses based on criteria
            let filteredBuses = sampleBuses.filter(bus => {
                // Price filter
                if (bus.price > maxPrice) return false;
                
                // Time slot filter
                if (selectedTimeSlots.length > 0) {
                    const hour = parseInt(bus.departure.split(':')[0]);
                    let timeSlot = '';
                    if (hour >= 6 && hour < 12) timeSlot = 'morning';
                    else if (hour >= 12 && hour < 18) timeSlot = 'afternoon';
                    else if (hour >= 18 && hour < 21) timeSlot = 'evening';
                    else timeSlot = 'night';
                    
                    if (!selectedTimeSlots.includes(timeSlot)) return false;
                }
                
                // Bus type filter
                if (selectedBusTypes.length > 0) {
                    const busType = bus.type.toLowerCase();
                    const matchesType = selectedBusTypes.some(type => busType.includes(type));
                    if (!matchesType) return false;
                }
                
                return true;
            });
            
            displayBusResults(filteredBuses);
            closeFilterModal();
        }

        // Update the toggleFilters function to use the new modal
        function toggleFilters() {
            showFilterModal();
        }

        // Booking history functionality
        function saveBookingToHistory(bookingData) {
            let bookingHistory = JSON.parse(localStorage.getItem('busBookingHistory') || '[]');
            bookingHistory.unshift(bookingData); // Add to beginning
            bookingHistory = bookingHistory.slice(0, 10); // Keep only last 10 bookings
            localStorage.setItem('busBookingHistory', JSON.stringify(bookingHistory));
        }

        // Enhanced booking process
        function proceedToBooking() {
    if (selectedSeats.length === 0) {
        alert('Please select at least one seat.');
        return;
    }

    const bookingData = {
        from: document.getElementById('from').value,
        to: document.getElementById('to').value,
        date: document.getElementById('date').value,
        seat: selectedSeats.join(', '),
        price: `${currentBusData.price * selectedSeats.length}`,
        busName: currentBusData.name,
        status: 'Confirmed',
        travelDate: document.getElementById('date').value,
        seats: selectedSeats,
        totalAmount: currentBusData.price * selectedSeats.length,
        bus: currentBusData
    };

    // Show loading spinner on button
    const bookNowBtn = document.getElementById('bookNowBtn');
    bookNowBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    bookNowBtn.disabled = true;

    // Call backend API to save booking
    fetch('/api/book_bus', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'include',  // IMPORTANT: needed to send session cookie
        body: JSON.stringify(bookingData)
    })
    .then(res => {
        if (!res.ok) {
            throw new Error("Server returned status " + res.status);
        }
        return res.json();
    })
    .then(data => {
        console.log("✅ Booking saved:", data);

        // Close modal and show confirmation
        closeSeatModal();
        showBookingConfirmation(bookingData);
    })
    .catch(err => {
        console.error("❌ Booking failed:", err);
        alert("Booking failed. Please try again.");
    })
    .finally(() => {
        // Reset button
        bookNowBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Booking';
        bookNowBtn.disabled = false;
    });
}

        function showBookingConfirmation(bookingData) {
            const confirmationModal = document.createElement('div');
            confirmationModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1001;
                backdrop-filter: blur(5px);
            `;

            confirmationModal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 20px;
                    padding: 30px;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    animation: slideIn 0.3s ease-out;
                ">
                    <div style="color: #10b981; font-size: 4em; margin-bottom: 20px;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 style="color: #1f2937; margin-bottom: 20px;">Booking Confirmed!</h2>
                    <div style="background: #f8fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                        <p><strong>Booking ID:</strong> ${bookingData.id}</p>
                        <p><strong>Bus:</strong> ${bookingData.bus.name}</p>
                        <p><strong>Route:</strong> ${bookingData.from} → ${bookingData.to}</p>
                        <p><strong>Date:</strong> ${bookingData.travelDate}</p>
                        <p><strong>Seats:</strong> ${bookingData.seats.join(', ')}</p>
                        <p><strong>Total Amount:</strong> ₹${bookingData.totalAmount}</p>
                    </div>
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        A confirmation email has been sent to your registered email address.
                    </p>
                    <button onclick="closeConfirmationAndReset()" style="
                        padding: 12px 30px;
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    ">
                        <i class="fas fa-home"></i> Back to Home
                    </button>
                </div>
            `;

            // Add animation keyframes
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-50px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(confirmationModal);
            
            // Save to booking history
            saveBookingToHistory(bookingData);
            const formatted = formatBookingForDashboard("Bus", bookingData);
addBookingToDashboard(formatted);
        }

        function closeConfirmationAndReset() {
            // Remove confirmation modal
            const confirmationModal = document.querySelector('div[style*="z-index: 1001"]');
            if (confirmationModal) {
                confirmationModal.remove();
            }
            
            // Close seat modal
            closeSeatModal();
            
            // Reset form
            document.getElementById('busSearchForm').reset();
            document.getElementById('resultsSection').classList.remove('active');
            
            // Set minimum date to today
            document.getElementById('date').min = new Date().toISOString().split('T')[0];
        }

        // Initialize auto-complete on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupAutoComplete();
        });

        // Add loading animation for better UX
        function showLoadingAnimation() {
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loadingOverlay';
            loadingOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(79, 70, 229, 0.9);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                color: white;
            `;
            
            loadingOverlay.innerHTML = `
                <div style="
                    width: 60px;
                    height: 60px;
                    border: 4px solid rgba(255, 255, 255, 0.3);
                    border-top: 4px solid white;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin-bottom: 20px;
                "></div>
                <h3>Processing your booking...</h3>
                <p>Please wait while we confirm your seats</p>
            `;
            
            document.body.appendChild(loadingOverlay);
            
            return loadingOverlay;
        }

        function hideLoadingAnimation() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.remove();
            }
        }
        function addBookingToDashboard(booking) {
        localStorage.setItem('newBooking', JSON.stringify(booking));
        window.dispatchEvent(new StorageEvent('storage', {
            key: 'newBooking',
            newValue: JSON.stringify(booking)
        }));
    }

    function formatBookingForDashboard(bookingType, formData) {
        return {
            type: bookingType,
            from: formData.from,
            to: formData.to,
            date: formData.travelDate,
            seat: formData.seats.join(', '),
            busNumber: formData.bus?.name || "Bus",
            price: `₹${formData.totalAmount}`
        };
    }
    </script>
</body>
</html>